LPA-Program
===========

``LPA-Program`` allows the user to specify light intensities in physical units (umol/m^2/s), and obtain files that, when read by an LPA from an SD card, will generate these intensities.

Background
==========

The Light Plate Apparatus (LPA)
---------------------
The LPA is a device that uses LEDs to deliver two independent light signals to each well on a standard 24-well plate. LEDs can be easily swapped, so different light wavelengths can be used. For more information, please refer to [Gerhardt, et al. "An open-hardware platform for optogenetics and photobiology." Scientific Reports 6 (2016)](https://www.nature.com/articles/srep35363).

Programming
-----------

The design of light signals (light intensities per well over time), or *Programming*, is performed on a desktop computer.  Three files result from this process:
- ``program.lpf``: Binary file containing the intensities per well over time, in arbitrary units ranging from 0 to 4095. We refer to these as *grayscale* values, to distinguish them from true intensity values in physical units.
- ``gcal.txt``: List of *grayscale calibration* values, one per LED, ranging from 0 to 255. The purpose of these numbers is to adjust for well-to-well differences in intensity (see next section).
- ``dc.txt``: List of *dot correction* values, one per LED, ranging from 0 to 63. The purpose of these numbers is to scale the intensities produced by the LEDs. For example, an LED will produce twice the intensity at a dot correction value of 8 relative to a value of 4, provided that the calibration and grayscale values remain the same. A higher dot correction value results in a higher intensity, but also a lower resolution, since each grayscale step becomes a larger increment in intensity.

[Iris](http://taborlab.github.io/Iris/), described with the original publication, is a programming method that generates only ``program.lpf``. The other two files can be generated by hand, as described in the publication. In contrast, ``LPA-Program`` is a programming method that generates the three files at once.

Calibration
-----------
Due to manufacturing differences in the LEDs and the circuits that control them, the light intensities emmited by two LEDs in different wells can vary by a significant amount. Therefore, each LED should be separately *calibrated* to account for these differences. Calibration also allows us to report light intensities in physical units. Here, we use umol/m^2/s (micromol per meter squared per second).

Two approaches can be taken to perform calibration:
- Measure the intensities produced by each LED at some uniform grayscale and dot correction. Next, modify the values in ``gcal.txt`` so that the intensities of all LEDs are brought down to match the dimmest LED in the LPA. This will make all LEDs in the device produce the same intensity when using the same grayscale value. This results in an easy-to-understand mapping from grayscale to intensity, but can unnecessarily cripple the resolution of brigther LEDs. Both methods presented in the original publication (imager, spectrophotometer) use this approach. Iris also implicitly assumes that this approach is followed.
- Measure the intensities produced by each LED at some grayscale and dot correction. Use these measurements every time to calculate appropriate grayscale and dot correction values given specified intensities. Here, we keep all the calibration values at their maximum (255). This approach requires us to keep intensity measurements of each LED and run some complicated calculations for every new program. However, this allows us to use each LED with full resolution.

``LPA-Program`` takes the second approach. Intensity measurements should be available in a standard format specified below.

LED Sets
--------
The ability to change LEDs is an important feature of LPAs. We have found that calibration is only necessary once for each LED in each socket (channel). This means that the LED can be removed and placed back, and it will emit with the same intensity. We can generalize this and exchange, for example, a calibrated set of red LEDs with a set of blue LEDs. After finishing with the blue ones, we can replace the original red LEDs and find that the intensities are the same, provided that each LED is used in the same channel of the same well.

Therefore, ``LPA-Program`` uses the concept of LED Sets: A group of LEDs, each one in a specified well and channel of a specified LPA, for which calibration measurements are available.

Usage
=====

Format of Calibration Measurements
----------------------------------
To do.

Example
-------
To do.

